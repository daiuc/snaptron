---
params:
    tissue: Muscle
    group: 
    - group0
    - group1
    - group2
    - group3
    p_cutoff: 1e-8
title: "LeafcutterMD Analyses - GTEx `r params$tissue`"
author: "Chao Dai"
date: "updated `r Sys.Date()`"

output: 
  bookdown::html_notebook2:
    toc: no
    toc_float: no
    theme: readable
    highlight: textmate
    code_folding: hide
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = F, message = F, echo = F)

library(tidyverse)
library(data.table)
library(ggrastr)
library(ggrepel)
library(DT)
```

# GTEx `r params$tissue` {.tabset}


<!-- Tabbed section -->

## `r params$group[[1]]`

```{r}
# load Bladder intron level pvals
tissue = params$tissue
group = params$group[[1]]
p_cutoff = as.numeric(params$p_cutoff)
```

```{r}
intron = fread(paste0("../code/results/leafcutterMD/GTEx/", tissue, "/",  group, "_pVals.txt.gz"))
cluster = fread(paste0("../code/results/leafcutterMD/GTEx/", tissue , "/", group, "_clusterPvals.txt.gz"))
nums = fread(paste0("../code/results/SubsetCounts/GTEx/", tissue, "/nums_filtered/", group, "_perind.nums.gz"))
counts = fread(paste0("../code/results/SubsetCounts/GTEx/", 
                      tissue, "/counts/", group, "_perind.counts.gz"),
               header = T)

intron = rename(intron, "chrom" = "V1")
cluster = rename(cluster, "cluster" = "V1")
nums = rename(nums, "chrom" = "V1")

# filter only include counts where introns are in the intron df 
counts = counts[chrom %in% intron$chrom]

# add the column cluster
intron[, cluster := str_extract(chrom, "clu_.+")]
counts[, cluster := str_extract(chrom, "clu_.+")]
```


### Intron selection

Introns must satisfy the following criteria, based on p_cutoff = `r scales::scientific(p_cutoff)`

1.  cluster level p-value \< `r scales::scientific(p_cutoff)`
2.  minimum p-value of a given intron \< `r scales::scientific(p_cutoff)`

```{r}

# get a list of outlier intron cluster names - for filtering
cluster_rowMins = cluster[, -c("cluster")] %>% apply(1, min)
outlier_clusters = cluster[which(cluster_rowMins < p_cutoff), cluster] %>% unique

intron_rowMins = select(intron, where(is_numeric)) %>% apply(1, min)
intron$rowMins = intron_rowMins

# vector of outlier introns
outlier_introns = intron[
  cluster %in% outlier_clusters & rowMins < p_cutoff,
  ][order(rowMins), chrom] %>% unique
```

Introns that have outlier splicing events: Based on the above criteria, `r length(outlier_clusters)` intron clusters, and `r length(outlier_introns)` outlier introns are selected. Below are the outlier introns (top 500 rows):

```{r echo=TRUE}
select_introns = intron[cluster %in% outlier_clusters & rowMins < p_cutoff, chrom] %>% unique
```

### QQ plot

Select top introns and plot qq plot:

```{r fig.cap="QQ plot of introns with outlier splicing", include=FALSE, eval=FALSE}
intron[cluster %in% outlier_clusters & rowMins < p_cutoff][
  order(rowMins)][1:1000,] %>% 
  .[, -c("cluster", "rowMins")] %>% 
  column_to_rownames("chrom") %>% t %>% as.data.frame %>% as.list %>% 
  leafcutter::multiqq(.) + theme_bw() + 
    guides(color = guide_legend(nrow=2, title=NULL)) + 
    theme(legend.position = "bottom")
```

<!-- by sample -->

```{r  eval=T, include=T}
# QQ plot of min cluster p-values
pick_4_samples = colnames(select(intron, where(is.numeric))) %>% sample(4)
qq = leafcutter::multiqq(structure(as.list(intron[, ..pick_4_samples]), names = pick_4_samples))
rasterize(qq, layers = 'point', dpi = 100)
```

### Box plot of selected introns

```{r}

# counts file store intron excision ratio as string, convert it to numeric first
frac_to_dbl = function(frac_str) {
  frac = str_split(frac_str, "/", simplify=T) %>% as.numeric
  if (frac[[1]] == 0) {
    out = 0
  } else {
    out = frac[[1]] / frac[[2]]
  }
  return(out)
}
```


```{r }
# subset counts to include only introns that have passed selection criteria

# top 50 introns chosen by intron p-value (min)
top100_introns = intron[rowMins < 1e-8,][order(rowMins)][1:50, chrom]

# read counts
rc = nums[chrom %in% top100_introns] %>% 
  pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "rc")

# intron incision ratio
ir = counts[chrom %in% top100_introns, 2:(ncol(counts)-1)] %>%
  apply(2, function(v) map_dbl(v, ~frac_to_dbl(.x))) %>% as.data.table
ir[, chrom := counts[chrom %in% top100_introns, chrom]]
ir = pivot_longer(ir, cols = where(is.numeric), names_to = "samples", values_to = "ir")


# p values
pv = intron[chrom %in% select_introns, -c("rowMins")] %>% 
  pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "p")


```

```{r}
joined_top100 = inner_join(rc, ir, by = c("chrom", "samples")) %>% 
  inner_join(pv, by = c("chrom", "samples")) %>% 
  mutate(isOutlier = if_else(p < p_cutoff, "outlier", "non-outlier"))

DT::datatable(joined_top100, filter = "top") %>% 
  formatStyle(columns = "p", color = styleInterval(p_cutoff, c("coral", "black"))) %>% 
  formatRound(c("ir"), digits = 2) %>% 
  formatSignif("p")
```

```{r  fig.height=10, fig.width=12}

  
ggplot(joined_top100) + geom_boxplot(aes(chrom, rc)) + 
    geom_point(aes(chrom, rc, color = isOutlier), alpha = .3, position = "jitter") + 
    geom_text_repel(aes(chrom, rc, label = samples), data = filter(joined_top100, isOutlier=="outlier")) +
    scale_y_log10() + 
    labs(x = NULL, y = "reads", color = NULL, shape = NULL) + 
    theme_bw() + 
      theme(legend.position = "bottom", axis.text.x = element_text(angle = 90))
```


```{r  fig.height=10, fig.width=12}

ggplot(joined_top100) + geom_boxplot(aes(chrom, ir)) + 
    geom_point(aes(chrom, ir, color = isOutlier), alpha = .3, position = "jitter") + 
    geom_text_repel(aes(chrom, ir, label = samples), data = filter(joined_top100, isOutlier=="outlier")) +
    labs(x = NULL, y = "Intron incision ratio", color = NULL, shape = NULL) + 
    theme_bw() + 
      theme(legend.position = "bottom", axis.text.x = element_text(angle = 90))
```

```{r, fig.cap='Histgram of number of detected outlier samples per intron'}
outlier_df = inner_join(x = nums[chrom %in% outlier_introns] %>% 
             pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "rc"),
           y = intron[chrom %in% outlier_introns, -c("cluster", "rowMins")] %>% 
             pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "p"),
           by = c("chrom", "samples")
           ) %>% 
  mutate(isOutlier = p < p_cutoff) %>%
  filter(isOutlier) %>%
  group_by(chrom) %>% mutate(n_samples = unique(samples) %>% length)
  
ggplot(outlier_df) + geom_histogram(aes(n_samples)) + 
    theme_bw()

```


### Outlier Summary

Overall in GTEX `r tissue` `r group` with pvalue cutoff at `r p_cutoff`, there are in total `r length(unique(outlier_df$chrom))` outlier introns detected, that occurred among `r outlier_df$samples %>% unique %>% length` samples

```{r}
outlier_df %>% 
  group_by(samples) %>% 
  summarise(n_outlier_introns = length(unique(chrom))) %>% 
  ggplot() + geom_col(aes(samples, n_outlier_introns, fill = samples)) + 
    labs(x = "100 samples", y = "Number of outlier introns detected") + 
    scale_y_log10() + 
    theme_bw() + 
    theme(axis.text.x = element_blank(), legend.position = "None")
```



```{r include=FALSE}
rm(intron, cluster, counts)
gc()
```


<!-- Tabbed section -->

## `r params$group[[2]]`

```{r}
# load Bladder intron level pvals
tissue = params$tissue
group = params$group[[2]]
p_cutoff = as.numeric(params$p_cutoff)
```

```{r}
intron = fread(paste0("../code/results/leafcutterMD/GTEx/", tissue, "/",  group, "_pVals.txt.gz"))
cluster = fread(paste0("../code/results/leafcutterMD/GTEx/", tissue , "/", group, "_clusterPvals.txt.gz"))
nums = fread(paste0("../code/results/SubsetCounts/GTEx/", tissue, "/nums_filtered/", group, "_perind.nums.gz"))
counts = fread(paste0("../code/results/SubsetCounts/GTEx/", 
                      tissue, "/counts/", group, "_perind.counts.gz"),
               header = T)

intron = rename(intron, "chrom" = "V1")
cluster = rename(cluster, "cluster" = "V1")
nums = rename(nums, "chrom" = "V1")

# filter only include counts where introns are in the intron df 
counts = counts[chrom %in% intron$chrom]

# add the column cluster
intron[, cluster := str_extract(chrom, "clu_.+")]
counts[, cluster := str_extract(chrom, "clu_.+")]
```


### Intron selection

Introns must satisfy the following criteria, based on p_cutoff = `r scales::scientific(p_cutoff)`

1.  cluster level p-value \< `r scales::scientific(p_cutoff)`
2.  minimum p-value of a given intron \< `r scales::scientific(p_cutoff)`

```{r}

# get a list of outlier intron cluster names - for filtering
cluster_rowMins = cluster[, -c("cluster")] %>% apply(1, min)
outlier_clusters = cluster[which(cluster_rowMins < p_cutoff), cluster] %>% unique

intron_rowMins = select(intron, where(is_numeric)) %>% apply(1, min)
intron$rowMins = intron_rowMins

# vector of outlier introns
outlier_introns = intron[
  cluster %in% outlier_clusters & rowMins < p_cutoff,
  ][order(rowMins), chrom] %>% unique
```

Introns that have outlier splicing events: Based on the above criteria, `r length(outlier_clusters)` intron clusters, and `r length(outlier_introns)` outlier introns are selected. Below are the outlier introns (top 500 rows):

```{r echo=TRUE}
select_introns = intron[cluster %in% outlier_clusters & rowMins < p_cutoff, chrom] %>% unique
```

### QQ plot

Select top introns and plot qq plot:

```{r fig.cap="QQ plot of introns with outlier splicing", include=FALSE, eval=FALSE}
intron[cluster %in% outlier_clusters & rowMins < p_cutoff][
  order(rowMins)][1:1000,] %>% 
  .[, -c("cluster", "rowMins")] %>% 
  column_to_rownames("chrom") %>% t %>% as.data.frame %>% as.list %>% 
  leafcutter::multiqq(.) + theme_bw() + 
    guides(color = guide_legend(nrow=2, title=NULL)) + 
    theme(legend.position = "bottom")
```

<!-- by sample -->

```{r  eval=T, include=T}
# QQ plot of min cluster p-values
pick_4_samples = colnames(select(intron, where(is.numeric))) %>% sample(4)
qq = leafcutter::multiqq(structure(as.list(intron[, ..pick_4_samples]), names = pick_4_samples))
rasterize(qq, layers = 'point', dpi = 100)
```

### Box plot of selected introns

```{r}

# counts file store intron excision ratio as string, convert it to numeric first
frac_to_dbl = function(frac_str) {
  frac = str_split(frac_str, "/", simplify=T) %>% as.numeric
  if (frac[[1]] == 0) {
    out = 0
  } else {
    out = frac[[1]] / frac[[2]]
  }
  return(out)
}
```


```{r }
# subset counts to include only introns that have passed selection criteria

# top 50 introns chosen by intron p-value (min)
top100_introns = intron[rowMins < 1e-8,][order(rowMins)][1:50, chrom]

# read counts
rc = nums[chrom %in% top100_introns] %>% 
  pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "rc")

# intron incision ratio
ir = counts[chrom %in% top100_introns, 2:(ncol(counts)-1)] %>%
  apply(2, function(v) map_dbl(v, ~frac_to_dbl(.x))) %>% as.data.table
ir[, chrom := counts[chrom %in% top100_introns, chrom]]
ir = pivot_longer(ir, cols = where(is.numeric), names_to = "samples", values_to = "ir")


# p values
pv = intron[chrom %in% select_introns, -c("rowMins")] %>% 
  pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "p")


```

```{r}
joined_top100 = inner_join(rc, ir, by = c("chrom", "samples")) %>% 
  inner_join(pv, by = c("chrom", "samples")) %>% 
  mutate(isOutlier = if_else(p < p_cutoff, "outlier", "non-outlier"))

DT::datatable(joined_top100, filter = "top") %>% 
  formatStyle(columns = "p", color = styleInterval(p_cutoff, c("coral", "black"))) %>% 
  formatRound(c("ir"), digits = 2) %>% 
  formatSignif("p")
```

```{r fig.height=10, fig.width=12}

  
ggplot(joined_top100) + geom_boxplot(aes(chrom, rc)) + 
    geom_point(aes(chrom, rc, color = isOutlier), alpha = .3, position = "jitter") + 
    geom_text_repel(aes(chrom, rc, label = samples), data = filter(joined_top100, isOutlier=="outlier")) +
    scale_y_log10() + 
    labs(x = NULL, y = "reads", color = NULL, shape = NULL) + 
    theme_bw() + 
      theme(legend.position = "bottom", axis.text.x = element_text(angle = 90))
```


```{r  fig.height=10, fig.width=12}

ggplot(joined_top100) + geom_boxplot(aes(chrom, ir)) + 
    geom_point(aes(chrom, ir, color = isOutlier), alpha = .3, position = "jitter") + 
    geom_text_repel(aes(chrom, ir, label = samples), data = filter(joined_top100, isOutlier=="outlier")) +
    labs(x = NULL, y = "Intron incision ratio", color = NULL, shape = NULL) + 
    theme_bw() + 
      theme(legend.position = "bottom", axis.text.x = element_text(angle = 90))
```

```{r, fig.cap='Histgram of number of detected outlier samples per intron'}
outlier_df = inner_join(x = nums[chrom %in% outlier_introns] %>% 
             pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "rc"),
           y = intron[chrom %in% outlier_introns, -c("cluster", "rowMins")] %>% 
             pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "p"),
           by = c("chrom", "samples")
           ) %>% 
  mutate(isOutlier = p < p_cutoff) %>%
  filter(isOutlier) %>%
  group_by(chrom) %>% mutate(n_samples = unique(samples) %>% length)
  
ggplot(outlier_df) + geom_histogram(aes(n_samples)) + 
    theme_bw()

```


### Outlier Summary

Overall in GTEX `r tissue` `r group` with pvalue cutoff at `r p_cutoff`, there are in total `r length(unique(outlier_df$chrom))` outlier introns detected, that occurred among `r outlier_df$samples %>% unique %>% length` samples

```{r}
outlier_df %>% 
  group_by(samples) %>% 
  summarise(n_outlier_introns = length(unique(chrom))) %>% 
  ggplot() + geom_col(aes(samples, n_outlier_introns, fill = samples)) + 
    labs(x = "100 samples", y = "Number of outlier introns detected") + 
    scale_y_log10() + 
    theme_bw() + 
    theme(axis.text.x = element_blank(), legend.position = "None")
```



```{r include=FALSE}
rm(intron, cluster, counts)
gc()
```


<!-- Tabbed section -->

## `r params$group[[3]]`

```{r}
# load Bladder intron level pvals
tissue = params$tissue
group = params$group[[3]]
p_cutoff = as.numeric(params$p_cutoff)
```

```{r}
intron = fread(paste0("../code/results/leafcutterMD/GTEx/", tissue, "/",  group, "_pVals.txt.gz"))
cluster = fread(paste0("../code/results/leafcutterMD/GTEx/", tissue , "/", group, "_clusterPvals.txt.gz"))
nums = fread(paste0("../code/results/SubsetCounts/GTEx/", tissue, "/nums_filtered/", group, "_perind.nums.gz"))
counts = fread(paste0("../code/results/SubsetCounts/GTEx/", 
                      tissue, "/counts/", group, "_perind.counts.gz"),
               header = T)

intron = rename(intron, "chrom" = "V1")
cluster = rename(cluster, "cluster" = "V1")
nums = rename(nums, "chrom" = "V1")

# filter only include counts where introns are in the intron df 
counts = counts[chrom %in% intron$chrom]

# add the column cluster
intron[, cluster := str_extract(chrom, "clu_.+")]
counts[, cluster := str_extract(chrom, "clu_.+")]
```


### Intron selection

Introns must satisfy the following criteria, based on p_cutoff = `r scales::scientific(p_cutoff)`

1.  cluster level p-value \< `r scales::scientific(p_cutoff)`
2.  minimum p-value of a given intron \< `r scales::scientific(p_cutoff)`

```{r}

# get a list of outlier intron cluster names - for filtering
cluster_rowMins = cluster[, -c("cluster")] %>% apply(1, min)
outlier_clusters = cluster[which(cluster_rowMins < p_cutoff), cluster] %>% unique

intron_rowMins = select(intron, where(is_numeric)) %>% apply(1, min)
intron$rowMins = intron_rowMins

# vector of outlier introns
outlier_introns = intron[
  cluster %in% outlier_clusters & rowMins < p_cutoff,
  ][order(rowMins), chrom] %>% unique
```

Introns that have outlier splicing events: Based on the above criteria, `r length(outlier_clusters)` intron clusters, and `r length(outlier_introns)` outlier introns are selected. Below are the outlier introns (top 500 rows):

```{r echo=TRUE}
select_introns = intron[cluster %in% outlier_clusters & rowMins < p_cutoff, chrom] %>% unique
```

### QQ plot

Select top introns and plot qq plot:

```{r fig.cap="QQ plot of introns with outlier splicing", include=FALSE, eval=FALSE}
intron[cluster %in% outlier_clusters & rowMins < p_cutoff][
  order(rowMins)][1:1000,] %>% 
  .[, -c("cluster", "rowMins")] %>% 
  column_to_rownames("chrom") %>% t %>% as.data.frame %>% as.list %>% 
  leafcutter::multiqq(.) + theme_bw() + 
    guides(color = guide_legend(nrow=2, title=NULL)) + 
    theme(legend.position = "bottom")
```

<!-- by sample -->

```{r  eval=T, include=T}
# QQ plot of min cluster p-values
pick_4_samples = colnames(select(intron, where(is.numeric))) %>% sample(4)
qq = leafcutter::multiqq(structure(as.list(intron[, ..pick_4_samples]), names = pick_4_samples))
rasterize(qq, layers = 'point', dpi = 100)
```

### Box plot of selected introns

```{r}

# counts file store intron excision ratio as string, convert it to numeric first
frac_to_dbl = function(frac_str) {
  frac = str_split(frac_str, "/", simplify=T) %>% as.numeric
  if (frac[[1]] == 0) {
    out = 0
  } else {
    out = frac[[1]] / frac[[2]]
  }
  return(out)
}
```


```{r }
# subset counts to include only introns that have passed selection criteria

# top 50 introns chosen by intron p-value (min)
top100_introns = intron[rowMins < 1e-8,][order(rowMins)][1:50, chrom]

# read counts
rc = nums[chrom %in% top100_introns] %>% 
  pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "rc")

# intron incision ratio
ir = counts[chrom %in% top100_introns, 2:(ncol(counts)-1)] %>%
  apply(2, function(v) map_dbl(v, ~frac_to_dbl(.x))) %>% as.data.table
ir[, chrom := counts[chrom %in% top100_introns, chrom]]
ir = pivot_longer(ir, cols = where(is.numeric), names_to = "samples", values_to = "ir")


# p values
pv = intron[chrom %in% select_introns, -c("rowMins")] %>% 
  pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "p")


```

```{r}
joined_top100 = inner_join(rc, ir, by = c("chrom", "samples")) %>% 
  inner_join(pv, by = c("chrom", "samples")) %>% 
  mutate(isOutlier = if_else(p < p_cutoff, "outlier", "non-outlier"))

DT::datatable(joined_top100, filter = "top") %>% 
  formatStyle(columns = "p", color = styleInterval(p_cutoff, c("coral", "black"))) %>% 
  formatRound(c("ir"), digits = 2) %>% 
  formatSignif("p")
```

```{r  fig.height=10, fig.width=12}

  
ggplot(joined_top100) + geom_boxplot(aes(chrom, rc)) + 
    geom_point(aes(chrom, rc, color = isOutlier), alpha = .3, position = "jitter") + 
    geom_text_repel(aes(chrom, rc, label = samples), data = filter(joined_top100, isOutlier=="outlier")) +
    scale_y_log10() + 
    labs(x = NULL, y = "reads", color = NULL, shape = NULL) + 
    theme_bw() + 
      theme(legend.position = "bottom", axis.text.x = element_text(angle = 90))
```


```{r  fig.height=10, fig.width=12}

ggplot(joined_top100) + geom_boxplot(aes(chrom, ir)) + 
    geom_point(aes(chrom, ir, color = isOutlier), alpha = .3, position = "jitter") + 
    geom_text_repel(aes(chrom, ir, label = samples), data = filter(joined_top100, isOutlier=="outlier")) +
    labs(x = NULL, y = "Intron incision ratio", color = NULL, shape = NULL) + 
    theme_bw() + 
      theme(legend.position = "bottom", axis.text.x = element_text(angle = 90))
```

```{r, fig.cap='Histgram of number of detected outlier samples per intron'}
outlier_df = inner_join(x = nums[chrom %in% outlier_introns] %>% 
             pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "rc"),
           y = intron[chrom %in% outlier_introns, -c("cluster", "rowMins")] %>% 
             pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "p"),
           by = c("chrom", "samples")
           ) %>% 
  mutate(isOutlier = p < p_cutoff) %>%
  filter(isOutlier) %>%
  group_by(chrom) %>% mutate(n_samples = unique(samples) %>% length)
  
ggplot(outlier_df) + geom_histogram(aes(n_samples)) + 
    theme_bw()

```


### Outlier Summary

Overall in GTEX `r tissue` `r group` with pvalue cutoff at `r p_cutoff`, there are in total `r length(unique(outlier_df$chrom))` outlier introns detected, that occurred among `r outlier_df$samples %>% unique %>% length` samples

```{r}
outlier_df %>% 
  group_by(samples) %>% 
  summarise(n_outlier_introns = length(unique(chrom))) %>% 
  ggplot() + geom_col(aes(samples, n_outlier_introns, fill = samples)) + 
    labs(x = "100 samples", y = "Number of outlier introns detected") + 
    scale_y_log10() + 
    theme_bw() + 
    theme(axis.text.x = element_blank(), legend.position = "None")
```



```{r include=FALSE}
rm(intron, cluster, counts)
gc()
```


<!-- Tabbed section -->

## `r params$group[[4]]`

```{r}
# load Bladder intron level pvals
tissue = params$tissue
group = params$group[[4]]
p_cutoff = as.numeric(params$p_cutoff)
```

```{r}
intron = fread(paste0("../code/results/leafcutterMD/GTEx/", tissue, "/",  group, "_pVals.txt.gz"))
cluster = fread(paste0("../code/results/leafcutterMD/GTEx/", tissue , "/", group, "_clusterPvals.txt.gz"))
nums = fread(paste0("../code/results/SubsetCounts/GTEx/", tissue, "/nums_filtered/", group, "_perind.nums.gz"))
counts = fread(paste0("../code/results/SubsetCounts/GTEx/", 
                      tissue, "/counts/", group, "_perind.counts.gz"),
               header = T)

intron = rename(intron, "chrom" = "V1")
cluster = rename(cluster, "cluster" = "V1")
nums = rename(nums, "chrom" = "V1")

# filter only include counts where introns are in the intron df 
counts = counts[chrom %in% intron$chrom]

# add the column cluster
intron[, cluster := str_extract(chrom, "clu_.+")]
counts[, cluster := str_extract(chrom, "clu_.+")]
```


### Intron selection

Introns must satisfy the following criteria, based on p_cutoff = `r scales::scientific(p_cutoff)`

1.  cluster level p-value \< `r scales::scientific(p_cutoff)`
2.  minimum p-value of a given intron \< `r scales::scientific(p_cutoff)`

```{r}

# get a list of outlier intron cluster names - for filtering
cluster_rowMins = cluster[, -c("cluster")] %>% apply(1, min)
outlier_clusters = cluster[which(cluster_rowMins < p_cutoff), cluster] %>% unique

intron_rowMins = select(intron, where(is_numeric)) %>% apply(1, min)
intron$rowMins = intron_rowMins

# vector of outlier introns
outlier_introns = intron[
  cluster %in% outlier_clusters & rowMins < p_cutoff,
  ][order(rowMins), chrom] %>% unique
```

Introns that have outlier splicing events: Based on the above criteria, `r length(outlier_clusters)` intron clusters, and `r length(outlier_introns)` outlier introns are selected. Below are the outlier introns (top 500 rows):

```{r echo=TRUE}
select_introns = intron[cluster %in% outlier_clusters & rowMins < p_cutoff, chrom] %>% unique
```

### QQ plot

Select top introns and plot qq plot:

```{r fig.cap="QQ plot of introns with outlier splicing", include=FALSE, eval=FALSE}
intron[cluster %in% outlier_clusters & rowMins < p_cutoff][
  order(rowMins)][1:1000,] %>% 
  .[, -c("cluster", "rowMins")] %>% 
  column_to_rownames("chrom") %>% t %>% as.data.frame %>% as.list %>% 
  leafcutter::multiqq(.) + theme_bw() + 
    guides(color = guide_legend(nrow=2, title=NULL)) + 
    theme(legend.position = "bottom")
```

<!-- by sample -->

```{r  eval=T, include=T}
# QQ plot of min cluster p-values
pick_4_samples = colnames(select(intron, where(is.numeric))) %>% sample(4)
qq = leafcutter::multiqq(structure(as.list(intron[, ..pick_4_samples]), names = pick_4_samples))
rasterize(qq, layers = 'point', dpi = 100)
```

### Box plot of selected introns

```{r}

# counts file store intron excision ratio as string, convert it to numeric first
frac_to_dbl = function(frac_str) {
  frac = str_split(frac_str, "/", simplify=T) %>% as.numeric
  if (frac[[1]] == 0) {
    out = 0
  } else {
    out = frac[[1]] / frac[[2]]
  }
  return(out)
}
```


```{r prepBoxplotData}
# subset counts to include only introns that have passed selection criteria

# top 50 introns chosen by intron p-value (min)
top100_introns = intron[rowMins < 1e-8,][order(rowMins)][1:50, chrom]

# read counts
rc = nums[chrom %in% top100_introns] %>% 
  pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "rc")

# intron incision ratio
ir = counts[chrom %in% top100_introns, 2:(ncol(counts)-1)] %>%
  apply(2, function(v) map_dbl(v, ~frac_to_dbl(.x))) %>% as.data.table
ir[, chrom := counts[chrom %in% top100_introns, chrom]]
ir = pivot_longer(ir, cols = where(is.numeric), names_to = "samples", values_to = "ir")


# p values
pv = intron[chrom %in% select_introns, -c("rowMins")] %>% 
  pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "p")


```

```{r}
joined_top100 = inner_join(rc, ir, by = c("chrom", "samples")) %>% 
  inner_join(pv, by = c("chrom", "samples")) %>% 
  mutate(isOutlier = if_else(p < p_cutoff, "outlier", "non-outlier"))

DT::datatable(joined_top100, filter = "top") %>% 
  formatStyle(columns = "p", color = styleInterval(p_cutoff, c("coral", "black"))) %>% 
  formatRound(c("ir"), digits = 2) %>% 
  formatSignif("p")
```

```{r  fig.height=10, fig.width=12}

  
ggplot(joined_top100) + geom_boxplot(aes(chrom, rc)) + 
    geom_point(aes(chrom, rc, color = isOutlier), alpha = .3, position = "jitter") + 
    geom_text_repel(aes(chrom, rc, label = samples), data = filter(joined_top100, isOutlier=="outlier")) +
    scale_y_log10() + 
    labs(x = NULL, y = "reads", color = NULL, shape = NULL) + 
    theme_bw() + 
      theme(legend.position = "bottom", axis.text.x = element_text(angle = 90))
```


```{r  fig.height=10, fig.width=12}

ggplot(joined_top100) + geom_boxplot(aes(chrom, ir)) + 
    geom_point(aes(chrom, ir, color = isOutlier), alpha = .3, position = "jitter") + 
    geom_text_repel(aes(chrom, ir, label = samples), data = filter(joined_top100, isOutlier=="outlier")) +
    labs(x = NULL, y = "Intron incision ratio", color = NULL, shape = NULL) + 
    theme_bw() + 
      theme(legend.position = "bottom", axis.text.x = element_text(angle = 90))
```

```{r, fig.cap='Histgram of number of detected outlier samples per intron'}
outlier_df = inner_join(x = nums[chrom %in% outlier_introns] %>% 
             pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "rc"),
           y = intron[chrom %in% outlier_introns, -c("cluster", "rowMins")] %>% 
             pivot_longer(cols = where(is.numeric), names_to = "samples", values_to = "p"),
           by = c("chrom", "samples")
           ) %>% 
  mutate(isOutlier = p < p_cutoff) %>%
  filter(isOutlier) %>%
  group_by(chrom) %>% mutate(n_samples = unique(samples) %>% length)
  
ggplot(outlier_df) + geom_histogram(aes(n_samples)) + 
    theme_bw()

```


### Outlier Summary

Overall in GTEX `r tissue` `r group` with pvalue cutoff at `r p_cutoff`, there are in total `r length(unique(outlier_df$chrom))` outlier introns detected, that occurred among `r outlier_df$samples %>% unique %>% length` samples

```{r}
outlier_df %>% 
  group_by(samples) %>% 
  summarise(n_outlier_introns = length(unique(chrom))) %>% 
  ggplot() + geom_col(aes(samples, n_outlier_introns, fill = samples)) + 
    labs(x = "100 samples", y = "Number of outlier introns detected") + 
    scale_y_log10() + 
    theme_bw() + 
    theme(axis.text.x = element_blank(), legend.position = "None")
```



```{r include=FALSE}
rm(intron, cluster, counts)
gc()
```
